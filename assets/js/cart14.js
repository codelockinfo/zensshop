let cartData=[];function setupCartUI(){let t=document.getElementById("cartBtn"),e=document.getElementById("closeCart"),r=document.getElementById("sideCart"),a=document.getElementById("cartOverlay");t&&t.addEventListener("click",function(){refreshCart(),r.classList.remove("translate-x-full"),a.classList.remove("hidden"),document.body.style.overflow="hidden"}),e&&e.addEventListener("click",closeCartPanel),a&&a.addEventListener("click",closeCartPanel),document.addEventListener("keydown",function(t){"Escape"!==t.key||r.classList.contains("translate-x-full")||closeCartPanel()})}function closeCartPanel(){let t=document.getElementById("sideCart"),e=document.getElementById("cartOverlay");t.classList.add("translate-x-full"),e.classList.add("hidden"),document.body.style.overflow=""}function loadCart(){let t=getCookie("cart_items");if(t)try{let e=null;try{e=JSON.parse(t)}catch(r){try{e=JSON.parse(decodeURIComponent(t))}catch(a){console.error("Error parsing cart cookie:",a),e=null}}cartData=e&&Array.isArray(e)?e:[]}catch(i){console.error("Error parsing cart cookie:",i),cartData=[]}else cartData=[];updateCartUI(),updateCartCount()}async function refreshCart(){renderCartSkeleton();try{let t="undefined"!=typeof BASE_URL?BASE_URL:window.location.pathname.split("/").slice(0,-1).join("/")||"";t=t.replace(/\/$/,""),console.log("[CART] Refreshing from:",t+"/api/cart.php");let e=await fetch(t+"/api/cart.php?t="+new Date().getTime(),{method:"GET",headers:{"Content-Type":"application/json"}}),r=await e.json();if(r.success&&Array.isArray(r.cart)){if(cartData=r.cart,r.cookie_data)try{let a=new Date;a.setTime(a.getTime()+2592e6),document.cookie=`cart_items=${encodeURIComponent(r.cookie_data)}; expires=${a.toUTCString()}; path=/; SameSite=Lax${"https:"===window.location.protocol?"; Secure":""}`}catch(i){console.error("[CART] Error updating cookie from refresh:",i)}updateCartUI(),updateCartCount()}else loadCart()}catch(o){console.error("Error refreshing cart:",o),loadCart()}}function renderCartSkeleton(){let t=document.getElementById("cartItems");if(!t)return;let e="";for(let r=0;r<3;r++)e+=`
            <div class="mb-4 pb-4 border-b animate-pulse">
                <div class="flex items-center space-x-4">
                    <div class="w-20 h-20 bg-gray-200 rounded"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                        <div class="h-3 bg-gray-100 rounded w-1/2"></div>
                        <div class="h-3 bg-gray-100 rounded w-1/4"></div>
                    </div>
                    <div class="w-12 text-right space-y-2">
                        <div class="h-4 bg-gray-200 rounded ml-auto w-full"></div>
                        <div class="h-6 w-6 bg-gray-100 rounded ml-auto"></div>
                    </div>
                </div>
            </div>
        `;t.innerHTML=e}async function addToCart(t,e=1,r=null,a={}){r&&setBtnLoading(r,!0);try{let i="undefined"!=typeof BASE_URL?BASE_URL:window.location.pathname.split("/").slice(0,-1).join("/")||"";i=i.replace(/\/$/,""),console.log("[CART] Add URL:",i+"/api/cart.php");let o=await fetch(i+"/api/cart.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:t,quantity:e,variant_attributes:a})}),n=await o.json();if(!(n.success&&Array.isArray(n.cart)))return"function"==typeof showNotificationModal?showNotificationModal(n.message||"Failed to add product to cart","error"):"function"==typeof showNotification&&showNotification(n.message||"Failed to add product to cart","error"),{success:!1,message:n.message};{if(cartData=n.cart,n.cookie_data)try{let c=new Date;c.setTime(c.getTime()+2592e6);let s=`cart_items=${encodeURIComponent(n.cookie_data)}; expires=${c.toUTCString()}; path=/; SameSite=Lax${"https:"===window.location.protocol?"; Secure":""}`;document.cookie=s}catch(l){console.error("[CART] Error setting cookie:",l)}else if(n.cart&&Array.isArray(n.cart))try{let d=JSON.stringify(n.cart),u=new Date;u.setTime(u.getTime()+2592e6);let m=`cart_items=${encodeURIComponent(d)}; expires=${u.toUTCString()}; path=/; SameSite=Lax${"https:"===window.location.protocol?"; Secure":""}`;document.cookie=m}catch(p){console.error("[CART] Error setting cookie (fallback):",p)}loadCart();let f=window.location.pathname.includes("/cart")||document.querySelector(".cart-item");if(f)return window.location.reload(),n;updateCartUI(),updateCartCount(),"function"==typeof showNotificationModal?showNotificationModal("Product added to cart!","success"):"function"==typeof showNotification&&showNotification("Product added to cart!","success");let y=document.getElementById("sideCart"),h=document.getElementById("cartOverlay");return y&&h&&(y.classList.remove("translate-x-full"),h.classList.remove("hidden"),document.body.style.overflow="hidden"),n}}catch(g){return console.error("Error adding to cart:",g),showNotification("An error occurred. Please try again.","error"),{success:!1,message:g.message}}finally{r&&setBtnLoading(r,!1)}}async function updateCartItem(t,e,r=null,a={}){r&&setBtnLoading(r,!0);let i=cartData.find(e=>{let r=e.variant_attributes||{};return e.product_id==t&&JSON.stringify(r)===JSON.stringify(a||{})});if(i&&void 0!==i.stock_quantity&&e>i.stock_quantity){"function"==typeof showNotification&&showNotification(`Only ${i.stock_quantity} items available in stock`,"info"),e=i.stock_quantity;let o=parseInt(i.quantity)||0;if(o>=i.stock_quantity&&e>=o){r&&setBtnLoading(r,!1);return}}e<1&&(e=1);try{let n="undefined"!=typeof BASE_URL?BASE_URL:window.location.pathname.split("/").slice(0,-1).join("/")||"",c=await fetch(n+"/api/cart.php",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:t,quantity:e,variant_attributes:a})}),s=await c.json();if(s.success&&Array.isArray(s.cart)){if(cartData=s.cart,s.cookie_data)try{let l=new Date;l.setTime(l.getTime()+2592e6),document.cookie=`cart_items=${encodeURIComponent(s.cookie_data)}; expires=${l.toUTCString()}; path=/; SameSite=Lax${"https:"===window.location.protocol?"; Secure":""}`}catch(d){console.error("[CART] Error updating cookie:",d)}else if(s.cart)try{let u=JSON.stringify(s.cart),m=new Date;m.setTime(m.getTime()+2592e6),document.cookie=`cart_items=${encodeURIComponent(u)}; expires=${m.toUTCString()}; path=/; SameSite=Lax${"https:"===window.location.protocol?"; Secure":""}`}catch(p){console.error("[CART] Error updating cookie (fallback):",p)}loadCart();let f=window.location.pathname.includes("/cart")||document.querySelector(".cart-item");if(f){let y=document.querySelector(`.cart-item[data-product-id="${t}"]`);if(y){let h=y.querySelector(".item-quantity");h&&(h.textContent=e);let g=cartData.find(e=>e.product_id==t);if(g){let $=y.querySelector(".item-total");if($){let C=parseFloat(g.price)*parseInt(g.quantity),v=$.querySelector("span");v?v.textContent=formatCurrency(C,g.currency):$.textContent=formatCurrency(C,g.currency)}}if(void 0!==s.total){let x=document.getElementById("cartSubtotal"),b=document.getElementById("cartTotal"),w=cartData.length>0&&cartData[0].currency||"USD";x&&(x.textContent=formatCurrency(s.total,w)),b&&(b.textContent=formatCurrency(s.total,w))}}else{window.location.reload();return}}else updateCartUI();void 0!==s.count&&(window.lastCartCount=s.count),updateCartCount()}else"function"==typeof showNotificationModal?showNotificationModal(s.message||"Failed to update cart","error"):"function"==typeof showNotification?showNotification(s.message||"Failed to update cart","error"):console.log(s.message||"Failed to update cart")}catch(I){console.error("Error updating cart:",I),"function"==typeof showNotification?showNotification("An error occurred. Please try again.","error"):console.log("An error occurred. Please try again.")}finally{r&&setBtnLoading(r,!1)}}async function removeFromCart(t,e=null,r={}){e&&setBtnLoading(e,!0);let a=window.location.pathname.includes("/cart")||document.querySelector(".cart-item");try{let i="undefined"!=typeof BASE_URL?BASE_URL:window.location.pathname.split("/").slice(0,-1).join("/")||"",o=await fetch(i+"/api/cart.php",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:t,variant_attributes:r})}),n=await o.json();if(n.success){if(cartData=Array.isArray(n.cart)?n.cart:[],n.cookie_data)try{let c=new Date;c.setTime(c.getTime()+2592e6),document.cookie=`cart_items=${encodeURIComponent(n.cookie_data)}; expires=${c.toUTCString()}; path=/; SameSite=Lax${"https:"===window.location.protocol?"; Secure":""}`}catch(s){console.error("[CART] Error updating cookie (remove):",s)}else if(n.cart)try{let l=JSON.stringify(n.cart),d=new Date;d.setTime(d.getTime()+2592e6),document.cookie=`cart_items=${encodeURIComponent(l)}; expires=${d.toUTCString()}; path=/; SameSite=Lax${"https:"===window.location.protocol?"; Secure":""}`}catch(u){console.error("[CART] Error updating cookie (remove fallback):",u)}if(loadCart(),a){let m=document.querySelector(`.cart-item[data-product-id="${t}"]`);if(m)m.style.transition="opacity 0.3s ease, transform 0.3s ease",m.style.opacity="0",m.style.transform="translateX(-20px)",setTimeout(()=>{if(m.remove(),void 0!==n.total){let t=document.getElementById("cartSubtotal"),e=document.getElementById("cartTotal");t&&(t.textContent=formatCurrency(n.total)),e&&(e.textContent=formatCurrency(n.total))}let r=document.querySelectorAll(".cart-item");0===r.length&&window.location.reload()},300);else{window.location.reload();return}}else updateCartUI();void 0!==n.count&&(window.lastCartCount=n.count),updateCartCount(),"function"==typeof showNotificationModal?showNotificationModal("Product removed from cart","success"):"function"==typeof showNotification&&showNotification("Product removed from cart","success")}else"function"==typeof showNotificationModal?showNotificationModal(n.message||"Failed to remove product","error"):"function"==typeof showNotification?showNotification(n.message||"Failed to remove product","error"):console.log(n.message||"Failed to remove product")}catch(p){console.error("Error removing from cart:",p),"function"==typeof showNotification?showNotification("An error occurred. Please try again.","error"):console.log("An error occurred. Please try again.")}finally{e&&setBtnLoading(e,!1)}}function updateCartUI(){let t=document.getElementById("cartItems"),e=document.getElementById("sideCartFooter"),r="undefined"!=typeof BASE_URL?BASE_URL:window.location.pathname.split("/").slice(0,-1).join("/")||"";if(!t)return;if(0===cartData.length){t.innerHTML=`
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-shopping-cart text-4xl mb-4"></i>
                <p>Your cart is empty</p>
            </div>
        `,e&&(e.innerHTML=`
                <a href="${r}/shop" class="inline-block bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-light hover:text-white transition w-full text-center hover:font-bold">
                    Continue Shopping
                </a>
            `);return}let a="",i=0;cartData.forEach(t=>{if(!t||!t.product_id||!t.name){console.warn("Invalid cart item:",t);return}let e=parseFloat(t.price)||0,o=parseInt(t.quantity)||1,n=e*o;i+=n;let c=t.image||"";c&&"null"!==c&&"undefined"!==c&&""!==c?0!==c.indexOf("http")&&0!==c.indexOf("/")&&0!==c.indexOf("data:")?c=r+"/assets/images/uploads/"+c:0!==c.indexOf("/")&&0!==c.indexOf("http")&&0!==c.indexOf("data:")&&(c=r+c):c="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+PGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMjAiIGZpbGw9IiM5QjdBOEEiLz48L3N2Zz4=";let s=t.variant_attributes||{},l=Object.entries(s).map(([t,e])=>`<span class="text-xs text-gray-500 block">${t}: ${e}</span>`).join(""),d=JSON.stringify(s).replace(/"/g,"&quot;");a+=`
            <div class="side-cart-item-wrapper mb-4 pb-4 border-b" data-product-id="${t.product_id}" data-attributes='${d}'>
                <div class="flex items-center space-x-4 side-cart-item" data-product-id="${t.product_id}">
                    <a href="product?slug=${t.slug}" class="shrink-0">
                        <img src="${escapeHtml(c)}" alt="${escapeHtml(t.name)}" class="w-20 h-20 object-cover rounded" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+PGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMjAiIGZpbGw9IiM5QjdBOEEiLz48L3N2Zz4='">
                    </a>
                    <div class="flex-1">
                        <h4 class="font-semibold text-sm mb-1">
                            <a href="product?slug=${t.slug}" class="hover:text-[#1a3d32] transition-colors uppercase line-clamp-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(t.name)}</a>
                        </h4>
                        ${l}
                        <p class="text-gray-600 text-sm mt-1">${formatCurrency(e,t.currency)}</p>
                        <div class="flex items-center space-x-2 mt-2">
                            <button onclick="updateCartItem(${t.product_id}, ${o-1}, this, ${d})" class="w-8 h-8 border rounded flex items-center justify-center hover:bg-gray-100 text-sm">-</button>
                            <span class="w-8 text-center text-sm font-semibold">${o}</span>
                            <button onclick="updateCartItem(${t.product_id}, ${o+1}, this, ${d})" class="w-8 h-8 border rounded flex items-center justify-center hover:bg-gray-100 text-sm">+</button>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-sm">${formatCurrency(n,t.currency)}</p>
                        <button onclick="showSideCartInlineRemoveConfirm(this)" class="text-red-500 hover:text-red-700 mt-2 text-sm" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <!-- Side Cart Inline Remove Confirmation -->
                <div class="side-cart-remove-confirm-inline flex items-center space-x-4 p-4 bg-gray-50 rounded border border-gray-300 hidden" data-product-id="${t.product_id}">
                    <a href="product?slug=${t.slug}" class="shrink-0">
                        <img src="${escapeHtml(c)}" alt="${escapeHtml(t.name)}" class="w-16 h-16 object-cover rounded border border-gray-200" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+PGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMjAiIGZpbGw9IiM5QjdBOEEiLz48L3N2Zz4='">
                    </a>
                    <div class="flex-1">
                        <h4 class="font-semibold text-sm mb-1 text-gray-800">
                            <a href="product?slug=${t.slug}" class="hover:text-[#1a3d32] transition-colors uppercase line-clamp-2" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(t.name)}</a>
                        </h4>
                        <p class="text-gray-600 text-xs mb-2">Add to wishlist before remove?</p>
                        <div class="flex space-x-2">
                            <button onclick="confirmSideCartInlineRemoveWithWishlist(this, ${t.product_id}, ${d})" class="px-4 py-1.5 bg-black text-white text-xs font-medium rounded hover:bg-gray-800 transition">Yes</button>
                            <button onclick="confirmSideCartInlineRemoveWithoutWishlist(this, ${t.product_id}, ${d})" class="px-4 py-1.5 border border-gray-300 text-gray-700 text-xs font-medium rounded hover:bg-gray-50 transition">No</button>
                        </div>
                    </div>
                    <button onclick="cancelSideCartInlineRemoveConfirm(this)" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>
        `}),t.innerHTML=a;let o=cartData.length>0&&cartData[0].currency||"USD";if(e)e.innerHTML=`
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-semibold">Total:</span>
                <span class="text-xl font-bold" id="cartTotal">${formatCurrency(i,o)}</span>
            </div>
            <a href="${r}/cart" class="block w-full bg-primary text-white text-center py-3 rounded-lg hover:bg-primary-light hover:text-white transition mb-2">
                View Cart
            </a>
            <a href="${r}/checkout" class="block w-full bg-black text-white text-center py-3 rounded-lg hover:text-white hover:bg-gray-800 transition">
                Checkout
            </a>
         `;else{let n=document.getElementById("cartTotal");n&&(n.textContent=formatCurrency(i,o))}}function updateCartCount(){let t=0;t=void 0!==window.lastCartCount?window.lastCartCount:cartData.reduce((t,e)=>t+parseInt(e.quantity||0),0);let e=document.querySelectorAll(".cart-count");e.forEach(e=>{e.textContent=t})}function getCookie(t){let e=`; ${document.cookie}`,r=e.split(`; ${t}=`);return 2===r.length?r.pop().split(";").shift():null}function showNotification(t,e="info"){if("function"==typeof showNotificationModal){showNotificationModal(t,e);return}let r=document.createElement("div");r.className=`fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${"success"===e?"bg-green-500":"error"===e?"bg-red-500":"bg-blue-500"} text-white`,r.textContent=t,document.body.appendChild(r),setTimeout(()=>{r.style.opacity="0",r.style.transition="opacity 0.3s",setTimeout(()=>{r.remove()},300)},3e3)}function escapeHtml(t){let e=document.createElement("div");return e.textContent=t,e.innerHTML}function formatCurrency(t,e){if(e){let r=e.toUpperCase();return(({USD:"$",EUR:"€",GBP:"\xa3",INR:"₹",CAD:"C$",AUD:"A$",JPY:"\xa5",KRW:"₩",CNY:"\xa5",RUB:"₽"})[r]||"₹")+parseFloat(t).toFixed(2)}let a="undefined"!=typeof CURRENCY_SYMBOL?CURRENCY_SYMBOL:"₹";return a+parseFloat(t).toFixed(2)}function showSideCartInlineRemoveConfirm(t){let e=t.closest(".side-cart-item-wrapper");if(e){let r=e.querySelector(".side-cart-item"),a=e.querySelector(".side-cart-remove-confirm-inline");r&&a&&(r.classList.add("hidden"),a.classList.remove("hidden"))}}function cancelSideCartInlineRemoveConfirm(t){let e=t.closest(".side-cart-item-wrapper");if(e){let r=e.querySelector(".side-cart-item"),a=e.querySelector(".side-cart-remove-confirm-inline");r&&a&&(r.classList.remove("hidden"),a.classList.add("hidden"))}}async function confirmSideCartInlineRemoveWithWishlist(t,e,r={}){t&&setBtnLoading(t,!0);let a="undefined"!=typeof BASE_URL?BASE_URL:window.location.pathname.split("/").slice(0,-1).join("/")||"";try{let i=await fetch(a+"/api/wishlist.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:e})}),o=await i.json();o.success&&"function"==typeof refreshWishlist&&await refreshWishlist(),await removeFromCart(e,null,r)}catch(n){console.error("Error adding to wishlist:",n),await removeFromCart(e,null,r)}finally{t&&document.body.contains(t)&&setBtnLoading(t,!1)}}async function confirmSideCartInlineRemoveWithoutWishlist(t,e,r={}){await removeFromCart(e,t,r)}document.addEventListener("DOMContentLoaded",function(){loadCart(),setupCartUI()}),window.addToCart=addToCart,window.updateCartItem=updateCartItem,window.removeFromCart=removeFromCart,window.refreshCart=refreshCart,window.updateCartUI=updateCartUI,window.updateCartCount=updateCartCount,window.showSideCartInlineRemoveConfirm=showSideCartInlineRemoveConfirm,window.cancelSideCartInlineRemoveConfirm=cancelSideCartInlineRemoveConfirm,window.confirmSideCartInlineRemoveWithWishlist=confirmSideCartInlineRemoveWithWishlist,window.confirmSideCartInlineRemoveWithoutWishlist=confirmSideCartInlineRemoveWithoutWishlist;
